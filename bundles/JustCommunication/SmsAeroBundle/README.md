# SmsAeroBundle
Отравка sms уведомлений через сервис SmsAero. Сервис платный, необходимо иметь там учетную запись и определенную сумму денег на балансе.

Есть режим работы в качестве заглушки.

! Функционал взят из рабочего проекта без глубокой переработки структуры и зависимостей, поэтому тестно завязан не неожиданные моменты типа redis и telegram.
Требуется переработка. Когда появится такая необходимость кто-нибудь обязательно этим займется.

## Установка 
`composer require justcommunication/smsaero-bundle`

## Требования
Требует telegram-bundle

## Подключение
Прописать в /config/services.yaml:
```
parameters:
    ...    
    redis:
        parameters:
            scheme: 'tcp'
            host: '127.0.0.1'
            port: 6379
        options:
            zzz: 10
    smsaero:
        url: "http://gate.smsaero.ru/v2/"
        login: "%env(SMSAERO_LOGIN)%"
        password: "%env(SMSAERO_PASSWORD)%"
        sign: "SMS Aero" # Подпись отправителя. Необходимо зарегистрировать перед использованием
        stub: 1 # Режим заглушки. Сервис кивает хоботом, что всё отправил, логирует, но не отправляет
        log_sms: 1 # Логирование отправлений в бд (необходимо для ограничения)
        day_limit_per_ip: 20 # ограничение отправляемых смс с одного Ip за сутки работает только при log_sms: 1
```

## Расширение Telegram Webhook-а
В проекте переопределить класс обработки вебкуха как описано в мануале TelegramBundle и добавить в него трейт:
```use SmsAeroWebhookTrait;```

## События SmsAero
Метод отправки сообщений генерирует одно единственное событие: превышен лимит отправки смс. Для того чтобы превратить это событие, например, в уведомление в телеграм, нужно выполнить 2 шага:

В `\config\packages\telegram.yaml` стоит добавить новое событие, хотя можно отправлять его как общий "Error"
```
    events:
        ...
        - {name: "Smsover", note: "Подписка на превышение лимита отправки смс", roles: ["Superuser"]}
```

Создать `EventSubscriber` в хост прокте. За основу можно взять `/EventSubscriber/TelegramEventSubscriber.php` лежащий в `TelegramBandle` изменив в нем событие `TelegramEvent` на `JustCommunication\SmsAeroBundle\Event\SmsAeroEvent` и название отправляемого события в ->event(). 
